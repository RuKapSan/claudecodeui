# Техническая архитектура Claude Code UI

## Оглавление

1. [Обзор архитектуры](#обзор-архитектуры)
2. [Технологический стек](#технологический-стек)
3. [Структура проекта](#структура-проекта)
4. [Backend архитектура](#backend-архитектура)
5. [Frontend архитектура](#frontend-архитектура)
6. [API и маршрутизация](#api-и-маршрутизация)
7. [WebSocket протокол](#websocket-протокол)
8. [Управление состоянием](#управление-состоянием)
9. [Система защиты сессий](#система-защиты-сессий)
10. [Безопасность](#безопасность)
11. [Производительность](#производительность)
12. [Диаграммы архитектуры](#диаграммы-архитектуры)

## Обзор архитектуры

Claude Code UI - это web-интерфейс для Claude Code CLI, предоставляющий полнофункциональный десктопный и мобильный UI для управления AI-ассистированными сессиями программирования. Приложение построено как full-stack JavaScript приложение с real-time коммуникацией через WebSocket.

### Ключевые архитектурные принципы

- **Разделение Frontend/Backend**: Четкое разделение между React frontend и Express backend
- **Real-time First**: WebSocket как основной канал коммуникации
- **Безопасность по умолчанию**: Все инструменты Claude отключены по умолчанию
- **Прогрессивное веб-приложение**: Поддержка PWA с offline функциональностью

## Технологический стек

### Frontend
- **React 18** - UI фреймворк с хуками
- **Vite** - Сборщик и dev сервер (порт 3009)
- **Tailwind CSS** - Утилитарный CSS фреймворк
- **CodeMirror 6** - Редактор кода с подсветкой синтаксиса
- **xterm.js** - Эмулятор терминала с WebGL ускорением
- **React Router v6** - Клиентская маршрутизация
- **React Markdown** - Рендеринг markdown в чате

### Backend
- **Node.js** - JavaScript runtime
- **Express** - Web сервер (порт 3008)
- **WebSocket (ws)** - Real-time двунаправленная коммуникация
- **node-pty** - Эмуляция терминала
- **Chokidar** - Отслеживание изменений файловой системы

### Инструменты сборки
- **Vite** - Бандлинг, HMR, оптимизация
- **PostCSS** - Обработка CSS с Tailwind и Autoprefixer
- **Concurrently** - Одновременный запуск frontend и backend

## Структура проекта

```
claudecodeui/
├── server/                 # Backend Node.js/Express
│   ├── index.js           # Основной сервер и WebSocket
│   ├── claude-cli.js      # Управление процессами Claude
│   ├── projects.js        # Управление проектами
│   └── routes/
│       └── git.js         # Git операции API
├── src/                   # Frontend React приложение
│   ├── App.jsx           # Корневой компонент с роутингом
│   ├── components/       # React компоненты
│   ├── contexts/         # React контексты
│   ├── hooks/            # Кастомные хуки
│   ├── utils/            # Утилиты
│   └── lib/              # Вспомогательные функции
├── public/               # Статические ресурсы
│   ├── manifest.json     # PWA манифест
│   ├── sw.js            # Service Worker
│   └── icons/           # Иконки приложения
└── dist/                # Production сборка
```

## Backend архитектура

### Основные архитектурные паттерны

1. **Service-Oriented Architecture**: Модульная организация сервисов
   - `index.js` - Express сервер и WebSocket обработка
   - `claude-cli.js` - Управление Claude CLI процессами
   - `projects.js` - Управление проектами и сессиями
   - `routes/git.js` - Git операции API

2. **Event-Driven Communication**: WebSocket для real-time обновлений

### Управление процессами Claude

```javascript
// Архитектура spawn процессов
const claudeProcess = spawn('claude', args, {
  cwd: projectPath,
  env: process.env,
  shell: true
});

// Поддержка режимов:
// - Новая сессия
// - Продолжение сессии (--resume)
// - Управление разрешениями инструментов
```

### Управление проектами

- Проекты хранятся в `~/.claude/projects/`
- URL-кодированные имена директорий
- Интеллектуальное извлечение путей из JSONL данных
- In-memory кеширование для производительности

### WebSocket сервер

Единый WebSocket сервер с маршрутизацией по URL:
- `/ws` - Чат интерфейс для Claude
- `/shell` - Терминальный интерфейс с node-pty

## Frontend архитектура

### Компонентная иерархия

```
App.jsx
├── ThemeProvider
├── Router
│   ├── Route "/" 
│   └── Route "/session/:sessionId"
├── Sidebar
│   ├── ProjectList
│   └── SessionList
├── MainContent
│   ├── ChatInterface
│   ├── FileTree
│   ├── GitPanel
│   ├── Shell
│   └── Preview
├── MobileNav
└── Модальные окна
```

### Ключевые архитектурные решения

1. **Функциональные компоненты**: Везде используются хуки вместо классов
2. **Композиция компонентов**: Переиспользуемые UI компоненты
3. **Responsive Design**: Адаптивная верстка с брейкпоинтом 768px
4. **Темная/светлая тема**: CSS переменные для тем

### Производительность Frontend

- **Мемоизация**: `MessageComponent` для предотвращения ререндеров
- **Виртуализация**: Ограничение отображаемых сообщений (последние 100)
- **Дебаунсинг**: Отложенная фильтрация и автодополнение
- **Lazy Loading**: Загрузка компонентов по требованию

## API и маршрутизация

### Frontend маршруты (React Router)

```
/ - Главная страница со списком проектов
/session/:sessionId - Просмотр сессии с чат интерфейсом
```

### Backend API endpoints

#### Конфигурация
- `GET /api/config` - Получение конфигурации WebSocket

#### Управление проектами
- `GET /api/projects` - Список проектов
- `POST /api/projects/create` - Создание проекта
- `PUT /api/projects/:projectName/rename` - Переименование
- `DELETE /api/projects/:projectName` - Удаление проекта

#### Управление сессиями
- `GET /api/projects/:projectName/sessions` - Список сессий
- `GET /api/projects/:projectName/sessions/:sessionId/messages` - Сообщения сессии
- `DELETE /api/projects/:projectName/sessions/:sessionId` - Удаление сессии

#### Файловые операции
- `GET /api/projects/:projectName/files` - Дерево файлов
- `GET /api/projects/:projectName/file` - Чтение файла
- `PUT /api/projects/:projectName/file` - Сохранение файла
- `GET /api/projects/:projectName/files/content` - Бинарные файлы

#### Git операции
- `/api/git/*` - Все git операции (status, diff, commit, etc.)

#### Дополнительно
- `POST /api/transcribe` - Транскрипция аудио через OpenAI Whisper

## WebSocket протокол

### Chat WebSocket (/ws)

#### Сообщения от клиента к серверу
```javascript
{
  type: 'claude-command',
  command: string,
  options: {
    projectPath: string,
    sessionId?: string,
    resume?: boolean,
    toolsSettings: object
  }
}

{
  type: 'abort-session',
  sessionId: string
}
```

#### Сообщения от сервера к клиенту
```javascript
{
  type: 'claude-response',
  data: string,
  sessionId?: string
}

{
  type: 'session-created',
  sessionId: string
}

{
  type: 'claude-status',
  data: {
    text: string,
    tokens: number,
    can_interrupt: boolean
  }
}

{
  type: 'claude-complete',
  exitCode: number
}

{
  type: 'projects_updated',
  projects: Array,
  changeType: string,
  affectedFiles: Array
}
```

### Shell WebSocket (/shell)

#### Инициализация
```javascript
{
  type: 'init',
  projectPath: string,
  sessionId?: string,
  hasSession: boolean
}
```

#### Ввод/вывод терминала
```javascript
// Клиент → Сервер
{
  type: 'input',
  data: string
}

// Сервер → Клиент
{
  type: 'output',
  data: string
}

{
  type: 'resize',
  cols: number,
  rows: number
}

{
  type: 'url_open',
  url: string
}
```

## Управление состоянием

### Паттерны управления состоянием

1. **React Context API**: Глобальная тема через `ThemeContext`
2. **Component State (useState)**: Локальное UI состояние
3. **URL State**: Session ID в параметрах URL
4. **LocalStorage**: Персистентные настройки пользователя
5. **SessionStorage**: Временные данные сессии

### Поток данных

```
Пользовательский ввод
    ↓
WebSocket.sendMessage()
    ↓
Backend обработка
    ↓
WebSocket broadcast
    ↓
App.jsx получает и фильтрует
    ↓
Компоненты обновляются
```

### Хранение состояния

- **In-Memory (Backend)**:
  - Активные Claude процессы (Map)
  - Подключенные WebSocket клиенты (Set)
  - Кеш директорий проектов (Map)

- **Файловая система**:
  - Конфигурации проектов (JSON)
  - Сессии (JSONL файлы)
  - Нет использования БД для простоты

## Система защиты сессий

Уникальная архитектурная особенность для предотвращения прерывания активных разговоров:

### Механизм работы

1. **Маркировка активной сессии**: При отправке сообщения сессия помечается как активная
2. **Блокировка обновлений**: WebSocket обновления проектов игнорируются во время активной сессии
3. **Временные идентификаторы**: Используются `new-session-${timestamp}` до получения реального ID
4. **Замена идентификаторов**: Временный ID заменяется на реальный без прерывания

### Реализация

```javascript
// Активация защиты
markSessionAsActive(sessionId)

// Деактивация после завершения
markSessionAsInactive(sessionId)

// Замена временного ID
replaceTemporarySession(realSessionId)
```

## Безопасность

### Реализованные меры безопасности

1. **Отключенные инструменты по умолчанию**: Все Claude инструменты требуют явного включения
2. **Валидация путей**: Проверка абсолютных путей
3. **Изоляция процессов**: Каждая Claude сессия в отдельном процессе
4. **CORS**: Включен для всех источников

### Отсутствующие меры безопасности

1. Нет аутентификации/авторизации
2. Нет rate limiting
3. Нет CSRF защиты
4. Нет валидации входных данных middleware
5. WebSocket принимает все подключения

### Рекомендации по безопасности

- Использовать только в доверенных сетях
- Добавить аутентификацию для production
- Реализовать rate limiting
- Добавить валидацию входных данных

## Производительность

### Оптимизации Backend

1. **Дебаунсинг**: 300мс задержка для файловых изменений
2. **Ранний выход**: Загрузка сессий останавливается при достижении лимита
3. **In-memory кеширование**: Директории проектов кешируются

### Оптимизации Frontend

1. **Мемоизация компонентов**: Предотвращение лишних ререндеров
2. **Ограничение рендеринга**: Максимум 100 сообщений в UI
3. **Дебаунсинг ввода**: 150мс задержка для фильтрации
4. **Lazy loading**: Загрузка компонентов по требованию

### Узкие места производительности

1. Синхронная обработка запросов
2. Отсутствие пагинации для больших проектов
3. Полная перезагрузка дерева файлов

## Диаграммы архитектуры

### Общая архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                        Browser                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              React Frontend (Vite)                   │   │
│  │  ┌─────────┐  ┌──────────┐  ┌─────────────────┐   │   │
│  │  │ Router  │  │Components│  │ WebSocket Client │   │   │
│  │  └────┬────┘  └────┬─────┘  └────────┬────────┘   │   │
│  └───────┼────────────┼─────────────────┼────────────┘   │
└──────────┼────────────┼─────────────────┼─────────────────┘
           │            │                 │
           │         HTTP/REST         WebSocket
           │            │                 │
┌──────────┼────────────┼─────────────────┼─────────────────┐
│          ▼            ▼                 ▼                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │            Express Backend (Node.js)                │   │
│  │  ┌──────────┐  ┌───────────┐  ┌──────────────┐    │   │
│  │  │ API Routes│  │WebSocket  │  │Claude Process│    │   │
│  │  │          │  │  Server    │  │  Manager     │    │   │
│  │  └────┬─────┘  └─────┬─────┘  └──────┬───────┘    │   │
│  └───────┼──────────────┼───────────────┼────────────┘   │
│          │              │               │                  │
│          ▼              ▼               ▼                  │
│  ┌──────────────┐ ┌──────────┐  ┌─────────────┐          │
│  │ File System  │ │ Terminal │  │ Claude CLI  │          │
│  │ ~/.claude/   │ │   PTY    │  │  Process    │          │
│  └──────────────┘ └──────────┘  └─────────────┘          │
└────────────────────────────────────────────────────────────┘
         Backend Server (Port 3008)
```

### Поток данных WebSocket

```
┌──────────┐    claude-command    ┌─────────────┐
│  Client  │ ──────────────────► │   Server    │
│          │                      │             │
│          │ ◄────────────────── │             │
└──────────┘  claude-response     └──────┬──────┘
                                         │
                                         ▼
                                  ┌─────────────┐
                                  │ Claude CLI  │
                                  │   Process   │
                                  └─────────────┘
```

### Архитектура компонентов Frontend

```
                    App.jsx
                      │
        ┌─────────────┴─────────────┐
        │                           │
    Sidebar                   MainContent
        │                           │
   ┌────┴────┐              ┌──────┴──────┐
   │         │              │             │
Projects  Sessions     ChatInterface  FileTree
                            │
                    ┌───────┴────────┐
                    │                │
              MessageList      InputArea
```

### Система защиты сессий

```
Состояние 1: Неактивная сессия
┌─────────────┐     Updates      ┌─────────────┐
│  WebSocket  │ ───────────────► │   Sidebar   │
│   Server    │                  │  (Updates)  │
└─────────────┘                  └─────────────┘

Состояние 2: Активная сессия (защищена)
┌─────────────┐     Updates      ┌─────────────┐
│  WebSocket  │ ───────X────────│   Sidebar   │
│   Server    │    (Blocked)     │ (No Update) │
└─────────────┘                  └─────────────┘
       │
       ▼
┌─────────────┐
│   Queued    │
│  Updates    │
└─────────────┘
```

## Заключение

Архитектура Claude Code UI демонстрирует зрелый подход к построению современного web-приложения с акцентом на:

1. **Real-time функциональность**: WebSocket как основа коммуникации
2. **Пользовательский опыт**: Система защиты сессий для непрерывных разговоров
3. **Производительность**: Множество оптимизаций для отзывчивого UI
4. **Масштабируемость**: Модульная архитектура с четким разделением ответственности

Архитектура хорошо подходит для desktop приложения, но потребует усиления безопасности и масштабируемости для production развертывания в публичных сетях.